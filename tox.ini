[tox]
envlist =
  doc
  py
  sty
skip_install = True
skip_missing_interpreters = True
skipsdist = True

[testenv]
allowlist_externals =
  pytest
commands =
  pytest {posargs}
description =
  Run all unit tests
passenv = *

[testenv:cov]
allowlist_externals =
  pytest
commands =
  pytest {posargs} \
    --cov-fail-under=35 \
    --cov-report=html \
    --cov-report=xml \
    --cov=compwa_policy
description =
  Compute test coverage

[testenv:doc]
allowlist_externals =
  sphinx-build
commands =
  sphinx-build \
    --builder html \
    --fail-on-warning \
    --keep-going \
    --show-traceback \
    docs/ docs/_build/html
description =
  Build documentation and API through Sphinx
setenv =
  FORCE_COLOR = yes

[testenv:doclive]
allowlist_externals =
  sphinx-autobuild
commands =
  sphinx-autobuild \
    --open-browser \
    --re-ignore '.*\.egg-info' \
    --re-ignore '.*/__pycache__/.*' \
    --re-ignore 'docs/_build/.*' \
    --re-ignore 'docs/api/.*' \
    --watch docs \
    --watch src \
    docs/ docs/_build/html
description =
  Set up a server to directly preview changes to the HTML pages
setenv =
  FORCE_COLOR = yes

[testenv:linkcheck]
allowlist_externals =
  sphinx-build
commands =
  sphinx-build \
    --builder linkcheck \
    --show-traceback \
    docs/ docs/_build/linkcheck
description =
  Check external links in the documentation (requires internet connection)
setenv =
  FORCE_COLOR = yes

[testenv:sty]
allowlist_externals =
  pre-commit
commands =
  pre-commit run {posargs} --all-files
description =
  Perform all linting, formatting, and spelling checks
setenv =
  SKIP = pyright
